<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="renderer" content="webkit" />
    <meta name="keywords" content="" />
    <meta name="description" content="" />
    <meta name="copyright" content="" />
    <title></title>
    <link rel="stylesheet" type="text/css" href="../../style/base.css" />
    <link rel="stylesheet" type="text/css" href="../slide/css2.css" />
    <style type="text/css">
    .m-timer span, .m-timer em, .m-timer b, .m-timer-slide { float:left;}
    .m-timer span, .m-timer b { margin:0 5px;}
    .m-timer span, .m-timer em, .m-timer b { line-height:37px;}
    .m-timer { height:37px;}
    .m-timer-slide { width:28px; height:35px; border:1px solid #cfcfcf; margin-left:-1px;}
    .m-timer-slide .ui-slide li { background:none; text-align:center; line-height:35px;}
    .m-timer-slide .ui-slide-list { display:none;}
    .m-tab .ui-tab li.s-crt a { color:#f00;}
    </style>
</head>

<body>
    <div>
        <div class="m-timer" id="test1" data-endtime="2015/01/14 13:30:00" data-stoptime="2015/01/14 14:30:00" data-nexttime="2015/01/14 14:28:00"></div>
        <div class="m-timer" data-endtime="2015/01/14 14:30:00" data-stoptime="2015/01/14 15:30:00" data-nexttime="2015/01/14 15:28:00"></div>
        <div class="m-timer" data-endtime="2015/01/14 15:30:00" data-stoptime="2015/01/14 16:30:00" data-nexttime="2015/01/21 14:28:00"></div>
        <div class="m-timer" data-endtime="2015/01/21 13:30:00" data-stoptime="2015/01/21 14:30:10"></div>
    </div>
    
    <div class="m-tab">
        <ul class="ui-tab">
            <li>
                <a href="javascript:void(0);">13:30</a>
                <ul>
                    <li><em data-repert="0">即将开始</em></li>
                    <li><em data-repert="0">即将开始</em></li>
                    <li><em data-repert="0">即将开始</em></li>
                    <li><em data-repert="0">即将开始</em></li>
                </ul>
            </li>
            <li>
                <a href="javascript:void(0);">14:30</a>
                <ul>
                    <li><em>即将开始</em></li>
                    <li><em>即将开始</em></li>
                    <li><em>即将开始</em></li>
                    <li><em>即将开始</em></li>
                </ul>
            </li>
            <li>
                <a href="javascript:void(0);">15:30</a>
                <ul>
                    <li><em>即将开始</em></li>
                    <li><em>即将开始</em></li>
                    <li><em>即将开始</em></li>
                    <li><em>即将开始</em></li>
                </ul>
            </li>
        </ul>
    </div>
    
    <script type="text/javascript" src="../../script/jquery.js"></script>
    <script type="text/javascript" src="jquery.timer.js"></script>
    <script type="text/javascript" src="../slide/jquery.superslide.js"></script>
    <script type="text/javascript" src="../tab/jquery.tab.js"></script>
	<script type="text/javascript">
	
    $('.m-tab').tab();
    
    function timer(object, inittime){
        object.data('starttime', inittime).timer({
            createItem:function(){
                var i, item = '';
                for(i=0; i<=9; i++){
                    item += '<li>'+ i +'</li>';
                }
                return item;
            },
            createDay:function(dayArray){
                var html = '', i;
                for(i in dayArray){
                    html += '<div class="m-timer-slide m-timer-day" data-moveto="'+ dayArray[i] +'"><ul class="ui-slide">'+ this.createItem() +'</ul></div>';
                }
                html += '<span class="m-timer-day">天</span>';
                return html;
            },
            createHtml:function(target, dayArray, dateArray, dateUnit, isAuto){
                var slide = html = '', i, j, k, temp, that = this, item = that.createItem();
                html += '<span class="m-timer-title">距离下一场开始还剩：</span>';
                html += '<div class="m-timer-box">';
                if(dayArray[0] != 0){
                    html += that.createDay(dayArray);
                }
                for(i in dateUnit){
                    for(j in temp = dateArray.slice(k = i*2, k+2)){
                        html += '<div class="m-timer-slide" data-moveto="'+ temp[j] +'"><ul class="ui-slide">'+ item +'</ul></div>';
                    }
                    html += '<span>'+ dateUnit[i] +'</span>';
                }
                html += '</div>';
                that.createSlide(target.append(html).find('.m-timer-slide'));
                !isAuto && this.nextCallback(target);
            },
            createSlide:function(target){
                target.superSlide({isAuto:false, isHorz:false, button:{enable:false, speed:300}});
            },
            runCallback:function(target, dayArray, dateArray, dateUnit, time){
                var index = target.index(), proTarget = $('.ui-tabody ul').eq(index);
                if(!proTarget.hasClass('s-dis')){
                    var that = this, day = target.find('div.m-timer-day');
                    if(day.size() > dayArray.length){
                        day.eq(0).remove();
                    }
                    else if(day.size() < dayArray.length && dayArray[0] != 0){
                        that.createSlide(target.find('.m-timer-box').prepend(that.createDay(dayArray)).end().find('.m-timer-slide'));
                    }
                    else if(dayArray[0] == 0){
                        target.find('.m-timer-day').remove();
                    }
                    target.find('.m-timer-slide').each(function(index, item){
                        $(this).find('.ui-slide-list span:eq('+ dateArray[index] +')').click();
                    });
                }
                else{
                    return true;
                }
            },
            nextCallback:function(target){
                target.find('.m-timer-title').text('距离本场结束仅剩：');
                var that, ul = $('.ui-tabody ul').eq(target.index()), em = ul.find('em'), i = 0;
                em.each(function(){
                    that = $(this);
                    if(that.data('repert') == '0'){
                        that.addClass('s-dis').text('已抢完');
                        i++;
                    }
                    else{
                        that.text('一元疯抢');
                    }
                });
                if(em.size() == i){
                    ul.addClass('s-dis');
                }
            },
            endCallback:function(target, starttime){
                $('.ui-tabody ul').eq(target.index()).find('em').addClass('s-dis').text('已抢完');
                if(target.next()[0]){
                    target.empty().hide();
                    timer(target.next(), starttime);
                }
                else{
                    target.html('第二期活动已结束');
                }
            },
            showCallback:function(target, status){
                var index = target.index(), proTarget = $('.ui-tabody ul').eq(index).data('status', status);
                if(proTarget[0] && !proTarget.hasClass('s-show')){
                    $('.ui-tab li').eq(index).click();
                    proTarget.addClass('s-show');
                }
            }
        });
    }
    timer($('#test1'), '2015/01/14 16:31:55');
    
    $('.ui-tabody ul').on('click', 'li em', function(){  
        var that = $(this), ul = that.parents('ul'), url = that.data('href');
        switch(ul.data('status')){
            case 2:
                if(that.hasClass('s-dis')){
                    alert('已抢完，按原价购买');
                    return;
                }
                $.ajax({
                    url:'http://www.yinjiazeng.com/testdata/test/timer.php?callback=?',
                    cache:false,
                    dataType:'json',
                    success:function(data){
                        //已抢完
                        if(data.repert == 0){
                            that.addClass('s-dis').text('已抢完');
                            alert('对不起没有抢到，按原价购买');
                        }
                        //已抢到并且重复抢购
                        else if(data.seckill == 1){
                            alert('您已经参与过了本次活动，请等待下次活动');
                        }
                        //已抢到
                        else if(data.tips == 1){
                            alert('恭喜您抢到了，请到购物车查看');
                        }
                        if(ul.find('em.s-dis').size() == ul.find('li').size()){
                            that.parents('ul').addClass('s-dis');
                        }
                    }
                });
                break;
            case 3:
                alert('已抢完，按原价购买');
                break;
            default:   
                 alert('未开始，按原价购买');
        }
    });
	</script>
</body>
</html>